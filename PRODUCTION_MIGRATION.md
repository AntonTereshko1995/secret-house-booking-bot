# Production Migration Guide

Инструкция по миграции данных из SQLite в PostgreSQL на продакшен сервере Amvera.

## Текущая ситуация

- ✅ SQLite база: `/data/the_secret_house.db` (содержит все данные)
- ❌ PostgreSQL база: таблица `booking` пустая

## Вариант 1: Автоматическая миграция (рекомендуется)

Самый простой способ - использовать встроенную автоматическую миграцию.

### Шаги:

1. **Задеплоить новые скрипты на Amvera**
   ```bash
   git add .
   git commit -m "Add production migration scripts"
   git push
   ```

2. **На сервере Amvera: Очистить PostgreSQL базу**
   ```bash
   python clear_prod_database.py
   ```

   Скрипт запросит подтверждение и очистит все таблицы.

3. **Перезапустить бот**

   Бот автоматически обнаружит пустую PostgreSQL базу и запустит миграцию из `/data/the_secret_house.db`.

   В логах вы увидите:
   ```
   [AUTO-MIGRATION] Detected PostgreSQL database
   [AUTO-MIGRATION] PostgreSQL database is empty
   [AUTO-MIGRATION] Found SQLite file: /data/the_secret_house.db
   [AUTO-MIGRATION] Starting automatic data migration...
   [AUTO-MIGRATION] SUCCESS: Automatic data migration completed successfully!
   ```

4. **Проверить результат**

   Бот должен запуститься и работать с полной базой данных.

## Вариант 2: Ручная миграция

Если автоматическая миграция не срабатывает или нужен больший контроль.

### Шаги:

1. **Задеплоить скрипты** (как в варианте 1)

2. **На сервере Amvera: Запустить миграцию вручную**
   ```bash
   python migrate_production.py
   ```

   Скрипт:
   - Проверит наличие SQLite файла
   - Запросит подтверждение
   - Выполнит миграцию всех данных
   - Покажет детальный лог процесса

3. **Перезапустить бот**

## Безопасность

- ✅ SQLite база автоматически создаст бэкап перед миграцией
- ✅ Миграция использует транзакции (откат при ошибке)
- ✅ Скрипты проверяют существование файлов
- ✅ Требуют явного подтверждения перед выполнением

## Ожидаемые результаты

После успешной миграции PostgreSQL база должна содержать:

- `user`: ~826 записей
- `booking`: ~245 записей
- `gift`: ~13 записей
- `promocode`: ~38 записей

## Troubleshooting

### Проблема: SQLite файл не найден

```bash
# Проверить путь к SQLite базе
ls -la /data/the_secret_house.db

# Если файл в другом месте, обновить путь в migrate_production.py
```

### Проблема: Ошибка Foreign Key

Это означает наличие "сиротских записей" в SQLite базе.

Решение:
```bash
# На локальной машине очистить сиротские записи
python -X utf8 cleanup_orphan_records.py the_secret_house.db --execute

# Загрузить очищенную базу на сервер
```

### Проблема: Миграция застряла

```bash
# Остановить бот
# Очистить PostgreSQL
python clear_prod_database.py

# Запустить миграцию снова
python migrate_production.py
```

## Проверка после миграции

После запуска бота проверьте:

1. **Логи бота** - не должно быть ошибок при запросах к базе
2. **Список бронирований** - команда `/booking_list` должна показывать все бронирования
3. **Создание новой записи** - попробуйте создать тестовое бронирование

## Контакты

При проблемах с миграцией проверьте логи и сообщите об ошибках.
